<!doctype html><html lang=en-uk><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Writing a discord library using Polysemy | ~simmsb</title><link rel=stylesheet href=/~simmsb/css/style.min.a82f329c90a5548a1b3eecd176d00a0a88e3f75617326a1e59758ac3d2147c4d.css><header><nav><ul><li class=pull-left><a href=/~simmsb/>/home/~simmsb</a></li></ul></nav></header></head><body><br><div class=article-meta><h1><span class=title>Writing a discord library using Polysemy</span></h1><h2 class=author>[Ben Simms]</h2><h2 class=date>2020/04/24</h2><p class=terms>Tags: <a href=/~simmsb/tags/programming>programming</a> <a href=/~simmsb/tags/haskell>haskell</a> <a href=/~simmsb/tags/polysemy>polysemy</a> <a href=/~simmsb/tags/free-monads>free-monads</a></p></div><main><p>Recently I&rsquo;ve migrated my <a href=https://github.com/nitros12/calamity>discord library</a> from mtl/transformers to <a href=https://github.com/isovector/polysemy>polysemy</a>
after reading as many blog posts as I could find on it. My main reasons for
wanting to migrate were escaping from having to write newtypes and all N
instances every time I had a more than one effect in my stack, and how little
boilerplate polysemy requires to write new effects.</p><p>In this<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> and some upcoming blog post I&rsquo;ll be writing about the challenges I
faced and solved<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> while going about the conversion.</p><h2 id=logging>Logging</h2><p>The first effect that I converted from mtl to Polysemy was logging, originally I
was using <a href=https://hackage.haskell.org/package/simple-log>simple-log</a> because I liked being able have areas of code run inside
logging &lsquo;scopes&rsquo;, at the time <a href=https://hackage.haskell.org/package/co-log-polysemy>co-log-polysemy</a> was the only existing logging
framework for polysemy and I was planning to use it, but instead I found <a href=https://hackage.haskell.org/package/di>di</a> and
decided to write a <a href=https://github.com/nitros12/di-polysemy>Polysemy effect for it</a>.</p><p>I&rsquo;ve updated this post with how the Di effect is implemented now, and left the
old one in for reference.</p><h3 id=current-implementation>Current implementation</h3><p>The current way I implement the logging effect is:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#069;font-weight:700>data</span> <span style=color:#078;font-weight:700>Di</span> level path msg m a <span style=color:#069;font-weight:700>where</span>
  <span style=color:#078;font-weight:700>Log</span>    <span style=color:#000;font-weight:700>::</span> level <span style=color:#000;font-weight:700>-&gt;</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Di</span> level path msg m <span style=color:#366>()</span>
  <span style=color:#078;font-weight:700>Flush</span>  <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Di</span> level path msg m <span style=color:#366>()</span>
  <span style=color:#078;font-weight:700>Local</span>  <span style=color:#000;font-weight:700>::</span> (<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level path msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level path msg) <span style=color:#000;font-weight:700>-&gt;</span> m a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Di</span> level path msg m a
  <span style=color:#078;font-weight:700>Fetch</span>  <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Di</span> level path msg m (<span style=color:#078;font-weight:700>Maybe</span> (<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level path msg))
</code></pre></div><p>The <code>Fetch</code> action is used to retrieve the current <code>Di</code> value if there is one,
an interpreter that doesn&rsquo;t do anything may return Nothing.</p><p>The handler for the effect is defined as follows:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>runDiToIOReader</span> <span style=color:#000;font-weight:700>::</span> forall r a level msg<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Members</span> <span style=color:#078;font-weight:700>&#39;[Embed IO, Reader (DC.Di level Df1.Path msg)]</span> r
      <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a</span>
      <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>runDiToIOReader</span> <span style=color:#000;font-weight:700>=</span> interpretH <span style=color:#555>$</span> <span style=color:#c0f>\</span><span style=color:#069;font-weight:700>case</span>
      <span style=color:#078;font-weight:700>Log</span> level msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
        di <span style=color:#000;font-weight:700>&lt;-</span> ask <span style=color:#555>@</span>(<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg)
        (embed <span style=color:#555>@</span><span style=color:#078;font-weight:700>IO</span> <span style=color:#555>$</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span>log di level msg) <span style=color:#555>&gt;&gt;=</span> pureT
      <span style=color:#078;font-weight:700>Flush</span>         <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
        di <span style=color:#000;font-weight:700>&lt;-</span> ask <span style=color:#555>@</span>(<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg)
        (embed <span style=color:#555>@</span><span style=color:#078;font-weight:700>IO</span> <span style=color:#555>$</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span>flush di) <span style=color:#555>&gt;&gt;=</span> pureT
      <span style=color:#078;font-weight:700>Local</span> f m     <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
        m&#39; <span style=color:#000;font-weight:700>&lt;-</span> runDiToIOReader <span style=color:#555>&lt;$&gt;</span> runT m
        raise <span style=color:#555>$</span> <span style=color:#078;font-weight:700>Polysemy</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Reader</span><span style=color:#555>.</span>local <span style=color:#555>@</span>(<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg) f m&#39;
      <span style=color:#078;font-weight:700>Fetch</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
        di <span style=color:#000;font-weight:700>&lt;-</span> <span style=color:#078;font-weight:700>Just</span> <span style=color:#555>&lt;$&gt;</span> ask <span style=color:#555>@</span>(<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg)
        pureT di

<span style=color:#c0f>runDiToIO</span> <span style=color:#000;font-weight:700>::</span> forall r level msg a<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Embed</span> <span style=color:#078;font-weight:700>IO</span>) r
  <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg
  <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a</span>
  <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>runDiToIO</span> di <span style=color:#000;font-weight:700>=</span> runReader di <span style=color:#555>.</span> runDiToIOReader <span style=color:#555>.</span> raiseUnder
</code></pre></div><p>We make use of the existing <code>Reader</code> effect to manage holding the <code>Di</code> value for us.</p><p>Additionally an interpreter can be defined that does nothing at all:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>runDiNoop</span> <span style=color:#000;font-weight:700>::</span> forall r level msg a<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a -&gt; Sem r a</span>
<span style=color:#c0f>runDiNoop</span> <span style=color:#000;font-weight:700>=</span> interpretH <span style=color:#c0f>\</span><span style=color:#069;font-weight:700>case</span>
      <span style=color:#078;font-weight:700>Log</span> _level _msg <span style=color:#000;font-weight:700>-&gt;</span> pureT <span style=color:#366>()</span>
      <span style=color:#078;font-weight:700>Flush</span>           <span style=color:#000;font-weight:700>-&gt;</span> pureT <span style=color:#366>()</span>
      <span style=color:#078;font-weight:700>Local</span> _f  m     <span style=color:#000;font-weight:700>-&gt;</span> runDiNoop <span style=color:#555>&lt;$&gt;</span> runT m <span style=color:#555>&gt;&gt;=</span> raise
      <span style=color:#078;font-weight:700>Fetch</span>           <span style=color:#000;font-weight:700>-&gt;</span> pureT <span style=color:#078;font-weight:700>Nothing</span>
</code></pre></div><p>After writing the interpreter, some helper functions can be written,
they&rsquo;re fairly repetitive so I&rsquo;ll only include the first few:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>push</span> <span style=color:#000;font-weight:700>::</span> forall level msg r a<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg) r <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Segment</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>push</span> s <span style=color:#000;font-weight:700>=</span> local <span style=color:#555>@</span>level <span style=color:#555>@</span><span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> <span style=color:#555>@</span>msg (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>push s)

<span style=color:#c0f>attr_</span> <span style=color:#000;font-weight:700>::</span> forall level msg r a<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg) r <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Key</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Value</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>attr_</span> k v <span style=color:#000;font-weight:700>=</span> local <span style=color:#555>@</span>level <span style=color:#555>@</span><span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> <span style=color:#555>@</span>msg (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>attr_ k v)

<span style=color:#c0f>attr</span> <span style=color:#000;font-weight:700>::</span> forall value level msg r a<span style=color:#555>.</span> (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>ToValue</span> value, <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg) r) <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Key</span> <span style=color:#000;font-weight:700>-&gt;</span> value <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>attr</span> k v <span style=color:#000;font-weight:700>=</span> attr_ <span style=color:#555>@</span>level <span style=color:#555>@</span>msg k (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>value v)

<span style=color:#c0f>debug</span> <span style=color:#000;font-weight:700>::</span> forall msg path r<span style=color:#555>.</span> (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>ToMessage</span> msg, <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> path <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Message</span>) r) <span style=color:#000;font-weight:700>=&gt;</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r <span style=color:#366>()</span>
<span style=color:#c0f>debug</span> <span style=color:#000;font-weight:700>=</span> log <span style=color:#555>@</span><span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> <span style=color:#555>@</span>path <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Debug</span> <span style=color:#555>.</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>message
</code></pre></div><h3 id=old-attempt>Old attempt</h3><p>The effect definition is the following:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#069;font-weight:700>data</span> <span style=color:#078;font-weight:700>Di</span> level path msg m a <span style=color:#069;font-weight:700>where</span>
  <span style=color:#078;font-weight:700>Log</span>    <span style=color:#000;font-weight:700>::</span> level <span style=color:#000;font-weight:700>-&gt;</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Di</span> level path msg m <span style=color:#366>()</span>
  <span style=color:#078;font-weight:700>Flush</span>  <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Di</span> level path msg m <span style=color:#366>()</span>
  <span style=color:#078;font-weight:700>Push</span>   <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Segment</span> <span style=color:#000;font-weight:700>-&gt;</span> m a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg m a
  <span style=color:#078;font-weight:700>Attr_</span>  <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Key</span> <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Value</span> <span style=color:#000;font-weight:700>-&gt;</span> m a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg m a
</code></pre></div><p>I went on to write an interpreter making use of the existing framework in Di for
printing out the log, which I found simple to write as it mostly consisted of
playing jigsaw with types:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>go</span> <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Embed</span> <span style=color:#078;font-weight:700>IO</span>) r0 <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r0) a0 -&gt; Sem r0 a0</span>
<span style=color:#c0f>go</span> di m <span style=color:#000;font-weight:700>=</span> (`interpretH` m) <span style=color:#555>$</span> <span style=color:#c0f>\</span><span style=color:#069;font-weight:700>case</span>
  <span style=color:#078;font-weight:700>Log</span> level msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
    t <span style=color:#000;font-weight:700>&lt;-</span> embed <span style=color:#555>@</span><span style=color:#078;font-weight:700>IO</span> <span style=color:#555>$</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span>log di level msg
    pureT t
  <span style=color:#078;font-weight:700>Flush</span>         <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
    t <span style=color:#000;font-weight:700>&lt;-</span> embed <span style=color:#555>@</span><span style=color:#078;font-weight:700>IO</span> <span style=color:#555>$</span> <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span>flush di
    pureT t
  <span style=color:#078;font-weight:700>Push</span> s m&#39;     <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
    mm <span style=color:#000;font-weight:700>&lt;-</span> runT m&#39;
    raise <span style=color:#555>$</span> go (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>push s di) mm
  <span style=color:#078;font-weight:700>Attr_</span> k v m&#39;  <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
    mm <span style=color:#000;font-weight:700>&lt;-</span> runT m&#39;
    raise <span style=color:#555>$</span> go (<span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>attr_ k v di) mm
</code></pre></div><p>The handlers for <code>Log</code> and <code>Flush</code> are simple enough, just embed the IO action
and wrap the result, and the handlers for <code>Push</code> and <code>Attr</code> consist of running
the nested action with the modified logger state, this is pretty much <code>Reader</code>
and I could probably rewrite this to just reinterpret the <code>Di</code> effect in terms
of <code>Reader</code>.</p><p>However this interpreter needs to get a <a href=https://hackage.haskell.org/package/di-core-1.0.4/docs/Di-Core.html#t:Di><code>Di.Core.Di</code></a> from somewhere, and the
only place to do that<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> is to use <a href=https://hackage.haskell.org/package/di-core-1.0.4/docs/Di-Core.html#v:new>Di.Core.new</a> which has the signature:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>new</span>
  <span style=color:#000;font-weight:700>::</span> forall m level path msg a
  <span style=color:#555>.</span>  (<span style=color:#078;font-weight:700>MonadIO</span> m, <span style=color:#078;font-weight:700>Ex</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>MonadMask</span> m)
  <span style=color:#000;font-weight:700>=&gt;</span> (<span style=color:#078;font-weight:700>Log</span> level path msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>IO</span> <span style=color:#366>()</span>)
  <span style=color:#000;font-weight:700>-&gt;</span> (<span style=color:#078;font-weight:700>Di</span> level path msg <span style=color:#000;font-weight:700>-&gt;</span> m a)
  <span style=color:#000;font-weight:700>-&gt;</span> m a
</code></pre></div><p>That <a href=https://hackage.haskell.org/package/exceptions-0.10.0/docs/Control-Monad-Catch.html#t:MonadMask><code>MonadMask</code></a> constraint means that we can&rsquo;t just use polysemy&rsquo;s <code>Sem r</code>
monad, my first resolution to this was to <a href=https://github.com/nitros12/di-polysemy/blob/863cc0072d846b1d96eca6467bc836bd098f7bb7/src/DiPolysemy.hs#L68-L124>copy the source of <code>new</code></a> and replace
<a href=http://hackage.haskell.org/package/safe-exceptions-0.1.7.0/docs/Control-Exception-Safe.html#v:finally><code>Control.Exception.Safe.finally</code></a> with polysemy&rsquo;s <a href=https://hackage.haskell.org/package/polysemy-1.3.0.0/docs/Polysemy-Resource.html#v:finally><code>Resource.finally</code></a><sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><p>This way required too much hackery for my liking, so I spent some time
figuring out how to lower a <code>Member (Embed IO) r => Sem r a</code> to <code>IO a</code>, and
luckily the <a href=https://hackage.haskell.org/package/polysemy-1.3.0.0/docs/src/Polysemy.Resource.html#resourceToIO><code>Resource</code></a> effect does pretty much what I want to do already, so my
current solution is to create a higher order effect with a single operation:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#069;font-weight:700>data</span> <span style=color:#078;font-weight:700>DiIOInner</span> m a <span style=color:#069;font-weight:700>where</span>
  <span style=color:#078;font-weight:700>RunDiIOInner</span> <span style=color:#000;font-weight:700>::</span> (<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Log</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>IO</span> <span style=color:#366>()</span>) <span style=color:#000;font-weight:700>-&gt;</span> (<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#000;font-weight:700>-&gt;</span> m a) <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>DiIOInner</span> m a
</code></pre></div><p>And define an interpreter:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>diToIO</span> <span style=color:#000;font-weight:700>::</span> forall r a<span style=color:#555>.</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Embed</span> <span style=color:#078;font-weight:700>IO</span>) r <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>DiIOInner</span> <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a -&gt; Sem r a</span>
<span style=color:#c0f>diToIO</span> <span style=color:#000;font-weight:700>=</span> interpretH
  (<span style=color:#c0f>\</span><span style=color:#069;font-weight:700>case</span> <span style=color:#078;font-weight:700>RunDiIOInner</span> commit a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
           istate <span style=color:#000;font-weight:700>&lt;-</span> getInitialStateT
           ma <span style=color:#000;font-weight:700>&lt;-</span> bindT a

           withLowerToIO <span style=color:#555>$</span> <span style=color:#c0f>\</span>lower finish <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
             <span style=color:#069;font-weight:700>let</span> done <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>DiIOInner</span> <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) x -&gt; IO x</span>
                 done <span style=color:#000;font-weight:700>=</span> lower <span style=color:#555>.</span> raise <span style=color:#555>.</span> diToIO

             <span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span>new commit (<span style=color:#c0f>\</span>di <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#069;font-weight:700>do</span>
                               res <span style=color:#000;font-weight:700>&lt;-</span> done (ma <span style=color:#555>$</span> istate <span style=color:#555>$&gt;</span> di)
                               finish
                               pure res))
</code></pre></div><p>This effect is only ever used internally in the implementation of <code>runDiToIO</code>:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>runDiToIO</span>
  <span style=color:#000;font-weight:700>::</span> forall r level msg a<span style=color:#555>.</span>
  <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Embed</span> <span style=color:#078;font-weight:700>IO</span>) r
  <span style=color:#000;font-weight:700>=&gt;</span> (<span style=color:#078;font-weight:700>DC</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Log</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>IO</span> <span style=color:#366>()</span>)
  <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a</span>
  <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>runDiToIO</span> commit m <span style=color:#000;font-weight:700>=</span> diToIO <span style=color:#555>$</span> runDiIOInner commit (`go` raiseUnder m)
  <span style=color:#069;font-weight:700>where</span>
    go <span style=color:#000;font-weight:700>::</span> <span style=color:#09f;font-style:italic>-- ...</span>
</code></pre></div><p>I&rsquo;m not sure if this is the best way to perform the ritual of lowering the Sem
monad to IO, but I can&rsquo;t see any way to perform it without having the ad-hoc
effect.</p><p>Anyway, after writing the interpreter, the helper functions can be written,
they&rsquo;re fairly repetitive so I&rsquo;ll only include the first few:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#c0f>runDiToStderrIO</span> <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Embed</span> <span style=color:#078;font-weight:700>IO</span>) r <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Sem</span> (<span style=color:#078;font-weight:700>Di</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Message</span> <span style=color:#c30>&#39;</span><span style=color:#a00;background-color:#faa>: r) a -&gt; Sem r a</span>
<span style=color:#c0f>runDiToStderrIO</span> m <span style=color:#000;font-weight:700>=</span> <span style=color:#069;font-weight:700>do</span>
  commit <span style=color:#000;font-weight:700>&lt;-</span> embed <span style=color:#555>@</span><span style=color:#078;font-weight:700>IO</span> <span style=color:#555>$</span> <span style=color:#078;font-weight:700>DH</span><span style=color:#555>.</span>stderr <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span>df1
  runDiToIO commit m

<span style=color:#c0f>attr</span> <span style=color:#000;font-weight:700>::</span> forall value level msg r a<span style=color:#555>.</span> (<span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>ToValue</span> value, <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> level <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> msg) r) <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Key</span> <span style=color:#000;font-weight:700>-&gt;</span> value <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r a
<span style=color:#c0f>attr</span> k v <span style=color:#000;font-weight:700>=</span> attr_ <span style=color:#555>@</span>level <span style=color:#555>@</span>msg k (<span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span>value v)

<span style=color:#c0f>debug</span> <span style=color:#000;font-weight:700>::</span> forall msg path r<span style=color:#555>.</span> (<span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>ToMessage</span> msg, <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> path <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Message</span>) r) <span style=color:#000;font-weight:700>=&gt;</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r <span style=color:#366>()</span>
<span style=color:#c0f>debug</span> <span style=color:#000;font-weight:700>=</span> log <span style=color:#555>@</span><span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> <span style=color:#555>@</span>path <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Debug</span> <span style=color:#555>.</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span>message

<span style=color:#c0f>info</span> <span style=color:#000;font-weight:700>::</span> forall msg path r<span style=color:#555>.</span> (<span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>ToMessage</span> msg, <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> path <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Message</span>) r) <span style=color:#000;font-weight:700>=&gt;</span> msg <span style=color:#000;font-weight:700>-&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r <span style=color:#366>()</span>
<span style=color:#c0f>info</span> <span style=color:#000;font-weight:700>=</span> log <span style=color:#555>@</span><span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> <span style=color:#555>@</span>path <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Info</span> <span style=color:#555>.</span> <span style=color:#078;font-weight:700>D</span><span style=color:#555>.</span>message
</code></pre></div><p>The manual type applications would normally not be necessary if you were to use
<a href=https://hackage.haskell.org/package/polysemy-plugin><code>Polysemy.Plugin</code></a>, but haddock currently (GHC 8.6.5) dies when it tries to build
docs with the plugin enabled.</p><h3 id=usage>Usage</h3><p>Now that the logger effect is written, we can use it like so:</p><div class=highlight><pre style=background-color:#f0f3f3;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-haskell data-lang=haskell><span style=color:#069;font-weight:700>import</span> <span style=color:#069;font-weight:700>qualified</span> <span style=color:#0cf;font-weight:700>Df1</span>
<span style=color:#069;font-weight:700>import</span>           <span style=color:#0cf;font-weight:700>DiPolysemy</span>
<span style=color:#069;font-weight:700>import</span>           <span style=color:#0cf;font-weight:700>Polysemy</span>
<span style=color:#069;font-weight:700>import</span>           <span style=color:#0cf;font-weight:700>Prelude</span>                     <span style=color:#069;font-weight:700>hiding</span> ( <span style=color:#c0f>error</span> )

<span style=color:#c0f>main</span> <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>IO</span> <span style=color:#366>()</span>
<span style=color:#c0f>main</span> <span style=color:#000;font-weight:700>=</span> runM <span style=color:#555>.</span> runDiToStderrIO <span style=color:#555>$</span> logTest

<span style=color:#c0f>logTest</span> <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Member</span> (<span style=color:#078;font-weight:700>Di</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Level</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Path</span> <span style=color:#078;font-weight:700>Df1</span><span style=color:#555>.</span><span style=color:#078;font-weight:700>Message</span>) r <span style=color:#000;font-weight:700>=&gt;</span> <span style=color:#078;font-weight:700>Sem</span> r <span style=color:#366>()</span>
<span style=color:#c0f>logTest</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#069;font-weight:700>do</span>
  info_ <span style=color:#c30>&#34;hello&#34;</span>
  notice_ <span style=color:#c30>&#34;this is a notice&#34;</span>
  push <span style=color:#c30>&#34;some-scope&#34;</span> <span style=color:#555>$</span> <span style=color:#069;font-weight:700>do</span>
    warning_ <span style=color:#c30>&#34;this is inside a scope&#34;</span>
    attr <span style=color:#c30>&#34;x&#34;</span> (<span style=color:#f60>4</span> <span style=color:#000;font-weight:700>::</span> <span style=color:#078;font-weight:700>Int</span>) <span style=color:#555>$</span> <span style=color:#069;font-weight:700>do</span>
      debug_ <span style=color:#c30>&#34;this one has an attribute&#34;</span>
  emergency_ <span style=color:#c30>&#34;and we&#39;re done&#34;</span>
</code></pre></div><p>Which produces the following:</p><pre><code class=language-nil data-lang=nil>2020-04-25T03:59:44.452126488Z INFO hello
2020-04-25T03:59:44.452136280Z NOTICE this is a notice
2020-04-25T03:59:44.452147183Z /some-scope WARNING this is inside a scope
2020-04-25T03:59:44.452156206Z /some-scope x=4 DEBUG this one has an attribute
2020-04-25T03:59:44.452162458Z EMERGENCY and we're done
</code></pre><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>This blog post was sponsored by <a href=https://theophile.choutri.eu/microfund.html>theophile.choutri.eu/microfund</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Although some of my solutions I feel aren&rsquo;t the best, and I&rsquo;d love to be made aware of any alternate solutions <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>Without writing my own logger <a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>Though this implementation probably doesn&rsquo;t respect async exceptions correctly in some way. <a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></main><footer><script>(function(){function center_el(tagName){var tags=document.getElementsByTagName(tagName),i,tag;for(i=0;i<tags.length;i++){tag=tags[i];var parent=tag.parentElement;if(parent.childNodes.length===1){if(parent.nodeName==='A'){parent=parent.parentElement;if(parent.childNodes.length!=1)continue;}
if(parent.nodeName==='P')parent.style.textAlign='center';}}}
var tagNames=['img','embed','object'];for(var i=0;i<tagNames.length;i++){center_el(tagNames[i]);}})();</script><hr><span class=pull-left><a href=https://github.com/nitros12>GitHub</a> | <a href=https://github.com/nitros12/blog_>Blog Source</a></span>
<span class=pull-right>This blog was written in <a href=https://www.gnu.org/software/emacs/>Emacs</a></span></footer></body></html>